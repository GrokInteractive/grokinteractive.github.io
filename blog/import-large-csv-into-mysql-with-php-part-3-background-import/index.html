<!DOCTYPE html>
<html lang="en">
<head>
  <title>Importing Large CSV files with PHP Part 3: Processing and Validating data in background</title>

<meta charset="utf-8">
<meta http-equiv="Content-Language" content="en" />
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<meta name="author" content="Grok Interactive, LLC">
<meta name="description" content="In a case where the structure of the CSV data requires some processing at the time of import you may want to consider processing it in the background. In this tutorial I will walk you through setting up an artisan command to process your import, and setting up a cron job to run the command in the background on your server.">
<meta name="MS.LOCALE" content="EN-US" />
<meta name="revisit-after" content="10 days" />
<meta name="robots" content="index,follow" />
<meta name="URL" content="http://www.grok-interactive.com" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta property="fb:admins" content="440639386014676"/>
<meta property="fb:admins" content="621293620"/>
<meta property="fb:admins" content="710704899"/>

<meta property="og:title" content="Importing Large CSV files with PHP Part 3: Processing and Validating data in background">

<meta property="og:type" content="article">

<meta property="og:url" content="http://www.grok-interactive.com/blog/import-large-csv-into-mysql-with-php-part-3-background-import/">


<meta property="og:image" content="http://www.grok-interactive.com/images/2015/08/CSV_into_MySQL.png">



<meta property="og:description" content="In a case where the structure of the CSV data requires some processing at the time of import you may want to consider processing it in the background. In thi...">


<meta property="og:site_name" content="Grok Interactive">

<meta property="og:locale" content="en_US">


<meta property="article:published_time" content="2015-10-06T00:00:00-04:00">


<meta property="fb:admins" content="">
<meta property="fb:app_id" content="">


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@GrokInteractive" />
<meta name="twitter:title" content="Importing Large CSV files with PHP Part 3: Processing and Validating data in background" />
<meta name="twitter:description" content="In a case where the structure of the CSV data requires some processing at the time of import you may want to consider processing it in the background. In this tutorial I will walk you through setting up an artisan command to process your import, and setting up a cron job to run the command in the background on your server." />
<meta name="twitter:url" content="http://www.grok-interactive.com/blog/import-large-csv-into-mysql-with-php-part-3-background-import/" />


<meta name="twitter:image" content="http://www.grok-interactive.com/images/2015/08/CSV_into_MySQL.png" />




<link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,800,300|Open+Sans+Condensed:300' type='text/css' />
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css' type='text/css' media='all' />

<link href='/assets/global-6b2036851216c08cdb9f2f1abbb4e9ac.css' rel='stylesheet' type='text/css' />

<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="/images/favicons/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicons/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="Grok Interactive, LLC"/>
<meta name="msapplication-TileColor" content="#000000" />
<meta name="msapplication-TileImage" content="/assets/img/favicons/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/assets/img/favicons/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/assets/img/favicons/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/assets/img/favicons/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/assets/img/favicons/mstile-310x310.png" />


</head>

<body style="display: none;">

  <div id="wrap">
    <div id="main">
      <header>
        <div class="navbar navbar-inverse navbar-static-top">
          <div class="navbar-inner">
            <div class="container">
              <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="brand grok-logo" href="/">Grok Interactive, LLC Home Page</a>
              <div class="nav-collapse collapse pull-right">
                <ul class="nav">
                  <li class='blog active'><a href="/blog/">Blog</a></li>
                  <li class='podcast'><a href="/podcast/">Podcast</a></li>
                  <li class='about'><a href="/#about" class='slide'>About</a></li>
                  <li class='service'><a href="/#service" class='slide'>Service</a></li>
                  <li class='work'><a href="/#work" class='slide'>Work</a></li>
                  <li class='contact'><a href="/#contact" class='slide'>Contact</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </header>
      <section class="podcast-cta" id="podcast-cta" >

        <div class="container">
          <div class="row">
            <div class="span12">

              <h4>Check out our new <a href="/podcast/">podcast</a> "The Grok Cast" now <a href="https://itunes.apple.com/us/podcast/the-grok-cast/id1036008796">available on iTunes!</a></h4>

            </div>
          </div>
        </div>

      </section>
      <div class="content">
  <div class="container">
    <div class="inner">
      <div class="canvas">

        <div class="columns">
          <div class="col c70">

            
            

            <div class="canvas">

              <div class="post" itemscope itemprop="blogPost" itemtype="http://schema.org/BlogPosting">

                <h1><a href="/blog/import-large-csv-into-mysql-with-php-part-3-background-import/" rel="bookmark" title="Link to Importing Large CSV files with PHP Part 3: Processing and Validating data in background" >Importing Large CSV files with PHP Part 3: Processing and Validating data in background</a></h1>
                <meta itemprop="name" content="Importing Large CSV files with PHP Part 3: Processing and Validating data in background">
                <meta itemprop="author" content="Anton Domratchev">
                <h5>by <a href="/blog/author/anton-domratchev" class="author" itemprop="author">Anton Domratchev</a>
                  &nbsp;&nbsp;&nbsp;<strong>Oct 06, 2015</strong>&nbsp;&nbsp;&nbsp;
                  
                  <i class="icon fa fa-folder" title="Categories"></i>
                  
                  <a href="/blog/category/software_development/" class="category">Software development</a>
                  
                  

                  
                  <i class="icon fa fa-tags" title="Tags"></i>
                  
                  <a href="/blog/tag/csv/" class="tag">Csv</a>,
                  
                  <a href="/blog/tag/mysql/" class="tag">Mysql</a>,
                  
                  <a href="/blog/tag/php/" class="tag">Php</a>,
                  
                  <a href="/blog/tag/laravel/" class="tag">Laravel</a>
                  
                  

                  
                </h5>

                <div class=''>

                  
                  <img src="/images/2015/08/CSV_into_MySQL.png" width="150" height="150" class="pull-right" />
                  

                  <p>So far we&#39;ve learned how we can import a large CSV file using one MySQL query. We also learned how we can validate the structure of the CSV file prior to import. In some cases using these two methods might work for imports where the structure of the CSV data matches the data of your application. However, in other cases you may need to pre process the data in order to fit it into the data structure of your application. You will need to implement background processing and validation to handle the data without delaying the HTTP request. In this blog post I will describe how to create an artisan command wich will be responsible for processing and validating data from an imported CSV, and a simple guide to seting up a cron job. </p>

<p>The basic idea in this implementation is that we will quickly import the entire CSV file into a temprorary table keep the file&#39;s original structure line by line. Next we will set up a cron job to run periodically and check this table for new records to be processed. We will also keep a simple log of each import attempt in order to get feedback on the data being processed. For this example our CSV will contain a list of users as well as a list of their favorite movies and music.</p>

<p>First we need to modify the CsvImporter to record the data into a temporary table. We will set up two modelsone for keeping track of each file and another for keeping each row of the file</p>

<hr>

<h3>Models</h3>

<p>This model will keep record of each CSV file we upload</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CsvImport</span> <span class="k">extends</span> <span class="nx">Eloquent</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$softDelete</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;original_filename&#39;</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">,</span>
        <span class="s1">&#39;row_count&#39;</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">csvRow</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="s1">&#39;csvRows&#39;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Now each time we upload a CSV file a <code>CsvImport</code> record will be created to reference that file, it will keep the status of the import as well as file&#39;s original file name this way we can keep track of the CSV file import. </p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CsvRow</span> <span class="k">extends</span> <span class="nx">Eloquent</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$softDelete</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;csv_import_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;header&#39;</span><span class="p">,</span>
        <span class="s1">&#39;content&#39;</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">csvImport</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="s1">&#39;csvImport&#39;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>This model will keep record of each row from the file including the header. For each row in the CSV we will create a <code>CsvRow</code> record containing the id of the <code>CsvImport</code> as well as header and row content. This way we will have a point of reference for each row of data.</p>

<hr>

<h3>Controller</h3>

<p>Now we need to modify our controller to match our new import structure. We will also inject the validator as dependency on the controller. (I&#39;ve removed inline comments to keep the code samples shorter)</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\Importing\CsvImporter</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\Importing\CsvImportValidator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CsvImport</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Input</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CsvImportController</span> <span class="k">extends</span> <span class="nx">BaseController</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$csv_import_validator</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">CsvImportValidator</span> <span class="nv">$csv_import_validator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import_validator</span> <span class="o">=</span> <span class="nv">$csv_import_validator</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Input</span><span class="o">::</span><span class="na">hasFile</span><span class="p">(</span><span class="s1">&#39;csv_import&#39;</span><span class="p">))</span> <span class="p">{</span> 
            <span class="nv">$csv_file</span> <span class="o">=</span> <span class="nx">Input</span><span class="o">::</span><span class="na">file</span><span class="p">(</span><span class="s1">&#39;csv_import&#39;</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$csv_file</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
                <span class="nv">$validator</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import_validator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$csv_file</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">Redirect</span><span class="o">::</span><span class="na">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">withErrors</span><span class="p">(</span><span class="nv">$validator</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nv">$original_filename</span> <span class="o">=</span> <span class="nv">$csv_file</span><span class="o">-&gt;</span><span class="na">getClientOriginalName</span><span class="p">();</span>

                <span class="nv">$csv_import</span> <span class="o">=</span> <span class="nx">CsvImport</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
                    <span class="s1">&#39;original_filename&#39;</span> <span class="o">=&gt;</span> <span class="nv">$original_filename</span><span class="p">,</span> 
                    <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;row_count&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span>
                <span class="p">]);</span>

                <span class="nv">$csv_importer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CsvFileImporter</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="nv">$csv_import</span><span class="o">-&gt;</span><span class="na">row_count</span> <span class="o">=</span> <span class="nv">$csv_importer</span><span class="o">-&gt;</span><span class="na">import</span><span class="p">(</span><span class="nv">$csv_file</span><span class="p">,</span> <span class="nv">$csv_import</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{</span><span class="nv">$csv_import</span><span class="o">-&gt;</span><span class="na">row_count</span><span class="si">}</span><span class="s2"> rows were imported!&quot;</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$message</span> <span class="o">=</span> <span class="s1">&#39;Your file did not import&#39;</span><span class="p">;</span>
                <span class="p">}</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$message</span> <span class="o">=</span> <span class="s1">&#39;You must provide a CSV file for import.&#39;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">Redirect</span><span class="o">::</span><span class="na">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Next we will need to update our CsvFileImporter to import the data inside of the CSV file into our temporary table and connect it to a single CsvImport record. This will help us keep track of what we need to process in our command. Once again I&#39;ve removed the inline comments for compactness. </p>

<hr>

<h3>CSV Importer</h3>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\Importing</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">DB</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CsvFileImporter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">import</span><span class="p">(</span><span class="nv">$csv_import</span><span class="p">,</span> <span class="nv">$csv_import_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$moved_file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">moveFile</span><span class="p">(</span><span class="nv">$csv_import</span><span class="p">);</span>

        <span class="nv">$normalized_file</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">normalize</span><span class="p">(</span><span class="nv">$moved_file</span><span class="p">);</span>

        <span class="nv">$csv_header</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCSVHeader</span><span class="p">(</span><span class="nv">$moved_file</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">importFileContents</span><span class="p">(</span><span class="nv">$normalized_file</span><span class="p">,</span> <span class="nv">$csv_import_id</span><span class="p">,</span> <span class="nv">$csv_header</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">moveFile</span><span class="p">(</span><span class="nv">$csv_import</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$destination_directory</span> <span class="o">=</span> <span class="nx">storage_path</span><span class="p">(</span><span class="s1">&#39;imports/tmp&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">chmod</span><span class="p">(</span><span class="nv">$destination_directory</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$destination_directory</span><span class="p">,</span> <span class="mo">0755</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$original_file_name</span> <span class="o">=</span> <span class="nv">$csv_import</span><span class="o">-&gt;</span><span class="na">getClientOriginalName</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$csv_import</span><span class="o">-&gt;</span><span class="na">move</span><span class="p">(</span><span class="nv">$destination_directory</span><span class="p">,</span> <span class="nv">$original_file_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">normalize</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$string</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$file_path</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$string</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">&#39;~\r\n?~&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>

        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$file_path</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">importFileContents</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">,</span> <span class="nv">$csv_import_id</span><span class="p">,</span> <span class="nv">$csv_header</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;LOAD DATA LOCAL INFILE &#39;%s&#39; INTO TABLE csv_rows </span>
<span class="s2">            LINES TERMINATED BY &#39;</span><span class="se">\\</span><span class="s2">n&#39;</span>
<span class="s2">            FIELDS TERMINATED BY &#39;</span><span class="se">\\</span><span class="s2">n&#39; </span>
<span class="s2">            IGNORE 1 LINES (`content`) </span>
<span class="s2">            SET csv_import_id = &#39;%s&#39;, header = &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$file_path</span><span class="p">),</span> <span class="nv">$csv_import_id</span><span class="p">,</span> <span class="nv">$csv_header</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">DB</span><span class="o">::</span><span class="na">connection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getpdo</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">getCSVHeader</span><span class="p">(</span><span class="nv">$file</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nv">$file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s2">&quot;The file (</span><span class="si">{</span><span class="nv">$file</span><span class="si">}</span><span class="s2">) could not be opened for reading&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;auto_detect_line_endings&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">fgets</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>

        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$header</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>We&#39;ve added and paramter to the import method, this will let us attach all of our content records to a <code>CsvImport</code> this way we will be ablet to track the status of the import and in the future keep track of errors, duplicates, and validation erros. Additionally, we&#39;ve added <code>getCSVHeader</code> method which will extract the header from the csv, this will allow us to save the header with each row of the data. We&#39;ve also modified the query to save the entire row as a field as well as csv_import_id and the header.</p>

<hr>

<h3>Artisan Command</h3>

<p>Now lets work on our artisan command. As I described earlier, the artisan command will help us do our record processing and validation through a command line. We will start by creating our artisan command</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\ArtisanCommands</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Console\Command</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProcessImportedCsvCommand</span> <span class="k">extends</span> <span class="nx">Command</span>
<span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * The console command name.</span>
<span class="sd">     *</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;acme:ProcessImportedCsvCommand&#39;</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * The console command description.</span>
<span class="sd">     *</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$description</span> <span class="o">=</span> <span class="s1">&#39;Command line file procesing command to process imported CSV file into the database&#39;</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * CSV import collection object</span>
<span class="sd">     *</span>
<span class="sd">     * @var CsvImport</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$csv_import</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * Execute the console command.</span>
<span class="sd">     *</span>
<span class="sd">     * @return mixed</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">fire</span><span class="p">()</span>
    <span class="p">{</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processFileImport</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cleanUp</span><span class="p">();</span>

    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Process file import data into application data</span>
<span class="sd">     *</span>
<span class="sd">     * @return  void</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="k">function</span> <span class="nf">processFileImport</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Disable query log to conserve on memory</span>
        <span class="nx">DB</span><span class="o">::</span><span class="na">connection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">disableQueryLog</span><span class="p">();</span>

        <span class="c1">// Find first pending file import and eager load the csvRows</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span> <span class="o">=</span> <span class="nx">CsvImport</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;csvRows&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;%s </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Nothing to process.&quot;</span><span class="p">);</span>
            <span class="k">exit</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Change the status of the import to avoid it being processed again.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="s1">&#39;processing&#39;</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">fileImportContent</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Get the header from the import</span>
            <span class="nv">$header</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">fileImportContent</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">;</span>

            <span class="c1">// Flip the values to keys and explode into array</span>
            <span class="nv">$header</span> <span class="o">=</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$header</span><span class="p">));</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">fileImportContent</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Convert the raw row data into array</span>
                <span class="nv">$row_array</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>

                <span class="c1">// Build array of import properties</span>
                <span class="nv">$import_array</span> <span class="o">=</span> <span class="nv">$header</span><span class="p">;</span>

                <span class="c1">// Match data array to the header array</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$import_array</span> <span class="k">as</span> <span class="nv">$index</span> <span class="o">=&gt;</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$import_array</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row_array</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
                <span class="p">}</span>

                <span class="sd">/** </span>
<span class="sd">                 * Here we can perform additional validation</span>
<span class="sd">                 * for each data field and save it to the database</span>
<span class="sd">                 */</span>

                <span class="c1">// Build array of parameters for our user import</span>
                <span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">firstOrCreate</span><span class="p">([</span>
                    <span class="s1">&#39;first_name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$import_array</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;last_name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$import_array</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$import_array</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
                <span class="p">]);</span>

                <span class="nv">$movies</span> <span class="o">=</span> <span class="nx">Movies</span><span class="o">::</span><span class="na">firstOrCreate</span><span class="p">([</span>
                    <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
                    <span class="s1">&#39;movie_list&#39;</span> <span class="o">=&gt;</span> <span class="nv">$import_array</span><span class="p">[</span><span class="s1">&#39;movies&#39;</span><span class="p">]</span>
                <span class="p">]);</span>

                <span class="nv">$music</span> <span class="o">=</span> <span class="nx">Music</span><span class="o">::</span><span class="na">firstOrCreate</span><span class="p">([</span>
                    <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
                    <span class="s1">&#39;music_list&#39;</span> <span class="o">=&gt;</span> <span class="nv">$import_array</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">]</span>
                <span class="p">]);</span>

            <span class="p">}</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="s1">&#39;processed&#39;</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

            <span class="c1">//Log error</span>

            <span class="k">exit</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">cleanUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">==</span> <span class="s1">&#39;processed&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csv_import</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>If you notice we are disabling the query log. This consumes a lot of memory because we can potentially execute thousands of queries while saving this data, its best to keep it disabled to avoid memory leaks.
The processFileImport method will fetch all of the CSV imports with the CSV rows eager loaded to avoid n+1 query issue. If we cant find any CSV imports that require processing we simply exit the command. If we do find a record we check to make sure it has csv rows, other wise we change the status to error and exit. At this time you may want to log something into the system log about this error. Once we find both CSV import and all of the rows, we extract the header and explode it into an array, we also flip the values to keys to be used in our import array. Once we have the header set up as keys we iterrate through each csv row and explode the content into array and assign it as values of our import array. As the final step we remove the csv import record, if our database table is setup to cascade the delete to its relation table all of the csv rows will be removed as well.</p>

<p>Now that we have the data array we can easily validate each value of the array and save it into our database. At this stage you can easily create statistics about the import, and record it in logging system or email it back to the user.</p>

<hr>

<h3>Artisan configuration</h3>

<p>Before we can start using our newly created command we must register the command with our application.</p>

<p>Find artisan config file in <code>app\start\artisan.php</code>. The only content is should have is the comment. Lets add our newly created artisan command</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

    <span class="cm">/*</span>
<span class="cm">    |--------------------------------------------------------------------------</span>
<span class="cm">    | Register The Artisan Commands</span>
<span class="cm">    |--------------------------------------------------------------------------</span>
<span class="cm">    |</span>
<span class="cm">    | Each available Artisan command must be registered with the console so</span>
<span class="cm">    | that it is available to be called. We&#39;ll register every command so</span>
<span class="cm">    | the console gets access to each of the command object instances.</span>
<span class="cm">    |</span>
<span class="cm">    */</span>
    <span class="nx">Artisan</span><span class="o">::</span><span class="na">add</span><span class="p">(</span><span class="nx">App</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="s2">&quot;Acme</span><span class="se">\\</span><span class="s2">ArtisanCommands</span><span class="se">\\</span><span class="s2">ProcessImportedCsvCommand&quot;</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Now when we run <code>php artisan</code> from the command line we will see <code>acme:ProcessImportedCsvCommand</code> as available command. Next we set up a simple cron job on the server which will execute our command at interval time.</p>

<hr>

<h3>Crontab</h3>

<p>From the terminal window run <code>crontab -e</code> if you are starting crontab for the first time it will prompt you to select your text editor. Next we will inset the a following command:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">    */10 * * * * <span class="sb">`</span>php /path/to/project/artisan acme:ProcessImportedCsvCommand<span class="sb">`</span>
</code></pre></div>
<p>This command will be executed every 10 minutes. You can find more information on <a href="https://en.wikipedia.org/wiki/Cron#CRON_expression">cron expressions here</a>.</p>

<hr>

<h3>Conclusion</h3>

<p>Now we&#39;ve learned how to import and process large CSV files in our application. We started with a simple SQL query which allowed us to grab all of the data from the CSV file and insert it directly into the database. Next we learned to validate the structure of the file. This validation is to simply make the users life a little simpler, we can tell the user that the format isnt what it needs to be we can avoid calls at 3 in the AM. Finally, we&#39;ve learned how to build an artisan command. We used all three steps in order to import, validate, and process the data in the background. These code samples are only meant to be used to convey the concept and could be written in much nicer testable way. I hope this article helps to get you on the right path of processing large CSV files, I sure wish I had this when I worked on it.</p>


                </div>

                

                <hr />

                
                
                <div class="author-profile">
  <div class="about">
    <em>ABOUT THE AUTHOR</em><br/>
    <strong>Anton Domratchev</strong><br/>
    <p>Anton graduated from the University of Texas at San Antonio with a degree in Cyber Security. Anton started front end development with HTML, CSS and JavaScript in 2008, and has been developing in PHP since 2013. He is currently honing his Ruby on Rails skills while discovering the wonderful world of Software Architecture.</p>
  </div>
  <img src="/images/portrait-anton-domratchev.jpg" />
</div>

                

                <hr>
<p>
  Grok Interactive specializes in web and mobile development using Ruby, Swift, Elixir, Javascript, and various other technologies to solve problems for our clients. If we can assist you, please do not hesitate to <a href="/#contact">contact us</a> today.
</p>


                <div class="share-page">
  Share this on &rarr;
  <a href="https://twitter.com/intent/tweet?text=Importing Large CSV files with PHP Part 3: Processing and Validating data in background&url=http://www.grok-interactive.com/blog/import-large-csv-into-mysql-with-php-part-3-background-import/&via=&related=" rel="nofollow" target="_blank" title="Share on Twitter">Twitter</a>
  <a href="https://facebook.com/sharer.php?u=http://www.grok-interactive.com/blog/import-large-csv-into-mysql-with-php-part-3-background-import/" rel="nofollow" target="_blank" title="Share on Facebook">Facebook</a>
  <a href="https://plus.google.com/share?url=http://www.grok-interactive.com/blog/import-large-csv-into-mysql-with-php-part-3-background-import/" rel="nofollow" target="_blank" title="Share on Google+">Google+</a>
</div>


                
<h3>Comments</h3>
<hr />
<!-- https://developers.facebook.com/docs/reference/plugins/comments/ -->
<div class='comments'>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'grokinteractive';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>



              </div>
            </div>


          </div>

          <div class="col c30">

            <div class="well">
  <h4><i class="icon fa fa-folder" title="Categories"></i> Categories</h4>
  <ul class="nav nav-list">
    

    <li><a href="/blog/category/general/">
      General
    </a></li>
    

    <li><a href="/blog/category/software_development/">
      Software development
    </a></li>
    

    <li><a href="/blog/category/training/">
      Training
    </a></li>
    

    <li><a href="/blog/category/testing/">
      Testing
    </a></li>
    

    <li><a href="/blog/category/environments/">
      Environments
    </a></li>
    

    <li><a href="/blog/category/business_development/">
      Business development
    </a></li>
    
  </ul>
</div>


            
<div class="well">
  <h4><i class="icon fa fa-users" title="Authors"></i> Authors</h4>
  <ul class="nav nav-list">
    
    
    <li><a href="/blog/author/jason-straughan">Jason Straughan</a></li>
    
    
    <li><a href="/blog/author/jason-ellis">Jason Ellis</a></li>
    
    
    <li><a href="/blog/author/josh-freeman">Josh Freeman</a></li>
    
    
    <li><a href="/blog/author/chris-hardee">Chris Hardee</a></li>
    
    
    <li><a href="/blog/author/john-guest">John Guest</a></li>
    
    
    <li><a href="/blog/author/anton-domratchev">Anton Domratchev</a></li>
    
    
    <li><a href="/blog/author/joseph-villafranca">Joseph Villafranca</a></li>
    
    
    <li><a href="/blog/author/christopher-moeller">Christopher Moeller</a></li>
    
  </ul>
</div>



            <div class="well">
  <h4><i class="icon fa fa-tags" title="Categories"></i> Tags</h4>

  <ul class="nav nav-list">
    
    <li><a href="/blog/tag/grok">Grok</a></li>
    
    <li><a href="/blog/tag/industry">Industry</a></li>
    
    <li><a href="/blog/tag/codeup">Codeup</a></li>
    
    <li><a href="/blog/tag/security">Security</a></li>
    
    <li><a href="/blog/tag/php">Php</a></li>
    
    <li><a href="/blog/tag/phpunit">Phpunit</a></li>
    
    <li><a href="/blog/tag/emacs">Emacs</a></li>
    
    <li><a href="/blog/tag/expression_engine">Expression engine</a></li>
    
    <li><a href="/blog/tag/javascript">Javascript</a></li>
    
    <li><a href="/blog/tag/dom">Dom</a></li>
    
    <li><a href="/blog/tag/jquery">Jquery</a></li>
    
    <li><a href="/blog/tag/git">Git</a></li>
    
    <li><a href="/blog/tag/githooks">Githooks</a></li>
    
    <li><a href="/blog/tag/source_control">Source control</a></li>
    
    <li><a href="/blog/tag/css">Css</a></li>
    
    <li><a href="/blog/tag/rails">Rails</a></li>
    
    <li><a href="/blog/tag/ubuntu">Ubuntu</a></li>
    
    <li><a href="/blog/tag/linux">Linux</a></li>
    
    <li><a href="/blog/tag/developers">Developers</a></li>
    
    <li><a href="/blog/tag/node.js">Node.js</a></li>
    
    <li><a href="/blog/tag/mongodb">Mongodb</a></li>
    
    <li><a href="/blog/tag/javascript">Javascript</a></li>
    
    <li><a href="/blog/tag/socket.io">Socket.io</a></li>
    
    <li><a href="/blog/tag/express.js">Express.js</a></li>
    
    <li><a href="/blog/tag/email">Email</a></li>
    
    <li><a href="/blog/tag/outlook">Outlook</a></li>
    
    <li><a href="/blog/tag/cross_mail_client">Cross mail client</a></li>
    
    <li><a href="/blog/tag/compatibility">Compatibility</a></li>
    
    <li><a href="/blog/tag/mvc">Mvc</a></li>
    
    <li><a href="/blog/tag/object_oriented_programming">Object oriented programming</a></li>
    
    <li><a href="/blog/tag/domain_driven_design">Domain driven design</a></li>
    
    <li><a href="/blog/tag/value_objects">Value objects</a></li>
    
    <li><a href="/blog/tag/types">Types</a></li>
    
    <li><a href="/blog/tag/csv">Csv</a></li>
    
    <li><a href="/blog/tag/mysql">Mysql</a></li>
    
    <li><a href="/blog/tag/laravel">Laravel</a></li>
    
    <li><a href="/blog/tag/ruby">Ruby</a></li>
    
    <li><a href="/blog/tag/functional_programming">Functional programming</a></li>
    
  </ul>
</div>


          </div>
        </div>

      </div>
    </div>

  </div>
</div>




    </div>
  </div>

  <footer>
  <div class="container">
    <div class="pull-left">
      <p>&copy; 2013&ndash;2015 Grok Interactive, LLC</p>
    </div>
  </div>
</footer>


  <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js'></script>

  <script src='/assets/global-5b2d0cc47ae047645ffc10228e2867fb.js' type='text/javascript'></script>

  <script src="//static.getclicky.com/js" type="text/javascript"></script>
  <script type="text/javascript">try{ clicky.init(100585693); }catch(e){}</script>
  <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100585693ns.gif" /></p></noscript>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-43998305-2', 'grok-interactive.com');
    ga('send', 'pageview');
  </script>
</body>
</html>
